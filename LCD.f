HEX

\ *** DICHIARAZIONE COSTANTI ***

\ Indirizzo di base dei registri 7E000000
7E000000 CONSTANT BASE

\ Alternate Function Select
BASE 200000 + CONSTANT GPFSEL0

\ Pin Output Set
BASE 20001C + CONSTANT GPSET0

\ Pin Output Clear
BASE 200028 + CONSTANT GPCLR0

804000 BASE + CONSTANT I2C_BASE

4 I2C_BASE + CONSTANT STATUS_REG
8 I2C_BASE + CONSTANT DLEN_REG
C I2C_BASE + CONSTANT SLAVE_ADDR
10 I2C_BASE + CONSTANT FIFO_REG

\ *** UTILS ***

: TO_I2C SET_SR SET_CR SET_DLEN SET_SA STORE SET_NT ;

: DELAY BEGIN 1 - DUP 0 = UNTIL DROP ;

\ MS(t_mus -- t_ms)
: MS 1000 * ;

: IS_CMD DUP 8 RSHIFT 1 = ;

: SEND_MSB
    DUP 8 RSHIFT SWAP
    F0 AND SWAP 2DUP 2DUP
    9 SWAP - OR TO_I2C
    D SWAP - OR TO_I2C
    9 SWAP - OR TO_I2C ;
    \ F0 AND DUP DUP
    \ 9 OR TO_I2C
    \ D OR TO_I2C
    \ 9 OR TO_I2C ;

: SEND_LSB
    DUP 8 RSHIFT SWAP
    0F AND 4 LSHIFT SWAP 2DUP 2DUP
    9 SWAP - OR TO_I2C
    D SWAP - OR TO_I2C
    9 SWAP - OR TO_I2C ;
    \ 0F AND 4 LSHIFT DUP DUP
    \ 9 OR TO_I2C
    \ D OR TO_I2C
    \ 9 OR TO_I2C ;

\ *** SETTAGGIO DEI REGISTRI ***

\ Imposta STATUS REGISTER
\ 0011 0000 0010
\ : SET_SR 302 STATUS_REG ! ;
: SET_SR STATUS_REG @ 302 OR STATUS_REG ! ;

\ 0011 0000 0000
\ : SET_SR 300 STATUS_REG ! ;

\ Ripristina CONTROL REGISTER
\ : SET_CR 10 I2C_BASE ! ;
: SET_CR I2C_BASE @ 10 OR I2C_BASE ! ;

\ Imposta DATA LENGHT
: SET_DLEN 1 DLEN_REG ! ;

\ Imposta SLAVE ADDRESS
\ : SET_SA 27 SLAVE_ADDR ! ;
: SET_SA SLAVE_ADDR ! ;

\ Memorizza i dati nel FIFO REGISTER
: STORE FIFO_REG ! ;

\ Imposta nuovo TRASFERIMENTO DATI
\ : SET_NT 8080 I2C_BASE ! ;
: SET_NT I2C_BASE @ 8080 OR I2C_BASE ! ;

\ ***  ***

\ IMPOSTA IL CLK (SCL1) A 1 E SDA1 A 1 PER ABILITARE LE ALT FUNCTION 0 DEI PIN GPIO2 E GPIO3 
\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 9C0 XOR -> 1100 0000 1100 0000 1100 1001 0000 0000 (C0C0C900)
: SETUP_I2C 9C0 GPFSEL0 @ XOR GPFSEL0 ! ;
\ : SETUP_I2C GPFSEL0 DUP @ 9C0 XOR SWAP ! ;

\ INVIO UN CARATTERE ALLO SLAVE
: TO_LCD DUP SEND_MSB SEND_LSB ;

\ INVIO UN COMANDO ALLO SLAVE
: CMD DUP SEND_MSB 1 MS DELAY SEND_LSB 2 MS DELAY ;

: SETUP_LCD 102 CMD 5 MS DELAY ;

: CLEAR_LCD 101 CMD 5 MS DELAY ;

: CONFIG SETUP_I2C SET_SA SETUP_LCD ; 

