HEX

: DELAY BEGIN 1 - DUP 0 = UNTIL DROP ;

: MS 1000 * DELAY ;

\ **** DICHIARAZIONE COSTANTI ****

7E000000 CONSTANT BASE

\ GPIO
\ Alternate Function Select
BASE 200000 + CONSTANT GPFSEL0

\ Pin Output Set
GPFSEL0 1C + CONSTANT GPSET0

\ Pin Output Clear
GPFSEL0 28 + CONSTANT GPCLR0

\ BSC
804000 BASE + CONSTANT BSC1             

00 BSC1 + CONSTANT CONTROL
04 BSC1 + CONSTANT STATUS
08 BSC1 + CONSTANT DLEN
0C BSC1 + CONSTANT SLAVE_ADDR
10 BSC1 + CONSTANT FIFO

\ **** SETTAGGIO DEI REGISTRI ****

: ALT0_2 GPFSEL0 DUP @ 1C0 XOR SWAP ! ;

: ALT0_3 GPFSEL0 DUP @ 800 OR SWAP ! ;

: SET_SA SLAVE_ADDR ! ;

: SET_DLEN DLEN ! ;

: APPEND FIFO ! ;

\ \ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 1110 0000 (D0) XOR -> 1100 0000 1100 0000 1100 0000 0010 0000 (C0C0C010)
\ : RESET_CR CONTROL @ D0 XOR CONTROL ! ;

\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 0011 1100 0010 (3C2) XOR -> 1100 0000 1100 0000 1100 0011 0000 0010 (C0C0C302)
\ : RESET_SR STATUS_REG @ 3C2 XOR STATUS_REG ! ;
\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 0011 0000 0010 (302) ! -> 0000 0000 0000 0000 0000 0011 0000 0010 (00000302)
: RESET_SR 302 STATUS_REG ! ;

\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 0001 0000 (10) ! -> 0000 0000 0000 0000 0000 0000 0001 0000 (00000010)
: CLEAR_FIFO 10 CONTROL ! ;

\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 1000 0000 1000 0000 (8080) ! -> 0000 0000 0000 0000 1000 0000 1000 0000 (00008080)
: SEND 8080 CONTROL ! ;

\ : CONFIG 
\     SWAP DUP GPFSEL0 ;

: INIT_I2C 
    ALT0_2
    ALT0_3
    27 SET_SA ;

: TO_I2C
    RESET_SR
    \ STATUS_REG DUP @ DROP DROP
    CLEAR_FIFO 
    \ CONTROL DUP @ DROP DROP
    01 SET_DLEN
    APPEND
    \ FIFO DUP @ DROP DROP
    SEND ;

\ MSB
: SEND_MSB
    DUP 08 RSHIFT SWAP
    F0 AND SWAP 2DUP 2DUP
    \ F0 AND SWAP 2DUP
    09 SWAP - OR TO_I2C
    0D SWAP - OR TO_I2C
    09 SWAP - OR TO_I2C ;

\ LSB
: SEND_LSB
    DUP 08 RSHIFT SWAP
    0F AND 04 LSHIFT SWAP 2DUP 2DUP
    \ 0F AND 04 LSHIFT SWAP 2DUP
    09 SWAP - OR TO_I2C
    0D SWAP - OR TO_I2C
    09 SWAP - OR TO_I2C ;

: CMD DUP SEND_MSB SEND_LSB 1 MS ;

: INIT DUP SEND_MSB 5 MS SEND_LSB 1 MS ;

: INIT_LCD 
    INIT_I2C
    ." INIT_I2C DONE "
    100 MS 
    33 INIT
    ." SENT 0x33 COMM "
    32 INIT
    ." SENT 0x32 COMM "
    28 CMD
    ." SENT 0x28 COMM "
    0E CMD
    ." SENT 0xE COMM "
    01 CMD
    ." SENT 0x1 COMM "
    5 MS ;

