HEX

: DELAY BEGIN 1 - DUP 0 = UNTIL DROP ;

: MS 1000 * DELAY;

\ **** DICHIARAZIONE COSTANTI ****

7E000000 CONSTANT BASE                      ( Indirizzo di base dei registri )

\ GPIO
BASE 200000 + CONSTANT GPFSEL0              ( Alternate Function Select )
GPFSEL0 1C + CONSTANT GPSET0                ( Pin Output Set )
GPFSEL0 28 + CONSTANT GPCLR0                ( Pin Output Clear )

\ BSC
804000 BASE + CONSTANT BSC1             

00 BSC1 + CONSTANT CONTROL
04 BSC1 + CONSTANT STATUS
08 BSC1 + CONSTANT DLEN
0C BSC1 + CONSTANT SLAVE_ADDR
10 BSC1 + CONSTANT FIFO

\ **** SETTAGGIO DEI REGISTRI ****

: ALT0_2 GPFSEL0 DUP @ 1C0 XOR SWAP ! ;

: ALT0_3 GPFSEL0 DUP @ 800 OR SWAP ! ;

: SET_SA SLAVE_ADDR ! ;

: SET_DLEN DLEN ! ;

: APPEND FIFO ! ;

\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 1000 0000 1000 0000 (8080) XOR -> 1100 0000 1100 0000 0100 0000 0100 0000 (C0C04040)
: RESET_CR CONTROL @ 8080 XOR CONTROL ! ;

: RESET_SR STATUS_REG @ 302 OR STATUS_REG ! ;

: CLEAR_FIFO CONTROL @ 10 OR CONTROL ! ;

: TRANSFER CONTROL @ 8080 OR CONTROL ! ;

\ : CONFIG 
\     SWAP DUP GPFSEL0 ;

: TO_I2C
    RESET_SR
    RESET_CR
    CLEAR_FIFO
    01 SET_DLEN
    APPEND
    TRANSFER ;

: INIT_I2C 
    ALT0_2
    ALT0_3
    27 SET_SA ;



