HEX

\ *** DEFINIZIONE COSTANTI ***

\\ Indirizzo di base dei registri 7E000000
7E000000 CONSTANT BASE

\\ Alternate Function Select
BASE 200000 + CONSTANT GPFSEL0

\\ Pin Output Set
BASE 20001C + CONSTANT GPSET0

\\ Pin Output Clear
BASE 200028 + CONSTANT GPCLR0

804000 BASE + CONSTANT I2C_BASE

4 I2C_BASE + CONSTANT STATUS_REG
8 I2C_BASE + CONSTANT DLEN_REG
C I2C_BASE + CONSTANT SLAVE_ADDR
10 I2C_BASE + CONSTANT FIFO_REG

\ *** UTILS ***

: DELAY BEGIN 1 - DUP 0 = UNTIL DROP ;

: SEND_MSB
    DUP 8 RSHIFT SWAP
    F0 AND SWAP 2DUP 2DUP
    9 SWAP - OR TO_I2C
    D SWAP - OR TO_I2C
    9 SWAP - OR TO_I2C ;
    \ F0 AND DUP DUP
    \ 9 OR TO_I2C
    \ D OR TO_I2C
    \ 9 OR TO_I2C ;

: SEND_LSB
    DUP 8 RSHIFT SWAP
    0F AND 4 LSHIFT SWAP 2DUP 2DUP
    9 SWAP - OR TO_I2C
    D SWAP - OR TO_I2C
    9 SWAP - OR TO_I2C ;
    \ 0F AND 4 LSHIFT DUP DUP
    \ 9 OR TO_I2C
    \ D OR TO_I2C
    \ 9 OR TO_I2C ;

\\ IMPOSTA I PIN 2 (SDA1) E 3 (SCL1) IN ALT0
\ GPFSEL0 DUP @ U. 120 XOR SWAP !

\ 1100 0000 1100 0000 1100 0000 1100 0000 (C0C0C0C0) 9C0 XOR -> 1100 0000 1100 0000 1100 1001 0000 0000 (C0C0C900)
: SETUP_I2C 9C0 GPFSEL0 @ XOR GPFSEL0 ! ;

\ *** SETTAGGIO DEI REGISTRI ***

\ Imposta STATUS REGISTER
\ 0011 0000 0010
: SET_SR 302 STATUS_REG ! ;

\ 0011 0000 0000
\ : SET_SR 300 STATUS_REG ! ;

\ Ripristina CONTROL REGISTER
: SET_CR 10 I2C_BASE ! ;

\ Imposta DATA LENGHT
: SET_DLEN 1 DLEN_REG ! ;

\ Imposta SLAVE ADDRESS
: SET_SA 27 SLAVE_ADDR ! ;

\ Memorizza i dati nel FIFO REGISTER
: STORE FIFO_REG ! ;

\ Imposta nuovo TRASFERIMENTO DATI
: SET_NT 8080 I2C_BASE ! ;

\ ***  ***

: TO_I2C SET_SR SET_CR SET_DLEN SET_SA STORE SET_NT ;

\ SE IL BIT 8 È POSTO A 1 RESTITUISCE FFFFFFFF PER INDICARE CHE È UN COMANDO. 0 ALTRIMENTI.
: IS_CMD DUP 8 RSHIFT 1 = ;

: DISPLAY IS_CMD SWAP TO_I2C ;

: CLEAR_DISPLAY 101 DISPLAY ;

\ INVIO UN CARATTERE ALLO SLAVE
: TO_LCD DUP SEND_MSB SEND_LSB ;

\ INVIO UN COMANDO ALLO SLAVE
: CMD DUP SEND_MSB SEND_LSB 1000 DELAY ;

: INIT DUP SEND_MSB 1000 DELAY SEND_LSB 1000 DELAY ;

: LCD.INIT  ;

\ *** ELENCO PAROLE ***

: WELCOME 
    57 DISPLAY 
    45 DISPLAY 
    4C DISPLAY 
    43 DISPLAY 
    4F DISPLAY 
    4D DISPLAY 
    45 DISPLAY 
    20 DISPLAY ;
    
